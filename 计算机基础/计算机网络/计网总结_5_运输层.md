# 计网总结(五)一运输层

* 一、概述
* 二、UDP
* 三、TCP连接管理
* 四、TCP可靠传输
* 五、TCP流量控制
* 六、TCP拥塞控制

## 一、概述
网络层是为主机之间提供逻辑通信，而运输层为应用进程之间提供**端到端的逻辑通信**。

即: **为相互通信的应用进程提供了逻辑通信**。

### 1、基本功能

* 传输层是**只有主机才有的层次**；
*  **为相互通信的应用进程提供了逻辑通信**；
* 为应用层提供**通信服务**，使用网络层的服务；
* 复用和分用；
* 传输层对收到的报文进行差错检测；

<div align="center"><img src="images/5_3.png" width="700"/> </div><br>

<div align="center"><img src="images/5_2.png" width="550"/></div><br>

**复用: 应用层所有的应用进程都可以通过传输层再传输到网路层**。

**分用: 传输层从网路层收到数据后交付指明的应用进程**。

### 2、传输层协议和应用层协议之间的关系

应用层协议很多，传输层就两个协议，如何使用传输层两个协议标识应用层协议呢? 通常传输层协议加一个**端口号**来标识一个应用层协议，如下图所示，展示了传输层协议和应用层协议之间的关系。

端口用一个 16 位端口号进行标志。

是逻辑端口/软件端口: 是传输层的SAP，标识主机中的应用进程。只有本地意义。

> 由此可见，两个计算机中的进程要互相通信，不仅必须知道对方的 IP 地址（为了找到对方的计算机），而且还要知道对方的端口号（为了找到对方计算机中的应用进程）。

端口号以及常用的熟知端口:


<div align="center"><img src="images/4_59.png" width="530"/></div><br>

> (1)、服务器端使用的端口号
> * 熟知端口，数值一般为 0~1023(包括)。
> * 登记端口号，数值为 1024~49151，为没有熟知端口号的应用程序使用的。使用这个范围的端口号必须在 IANA 登记，以防止重复。
> (2)、客户端使用的端口号
> * 又称为短暂端口号，数值为 49152~65535，留给客户进程选择暂时使用。
> * 当服务器进程收到客户进程的报文时，就知道了客户进程所使用的动态端口号。通信结束后，这个端口号可供其他客户进程以后使用。

> 套接字: **网络中采用发送方和接收方的套接字组合来识别端点，套接字唯一标识了网络中的一个主机和它上面的一个进程**。即套接字Socket = (主机IP地址，端口号)

整体过程:

![images/5_4.png](images/5_4.png)

> 网络层到传输层，用数据包中的**协议号**来标识是TCP还是UDP协议。
>
> `TCP : 6， UDP : 17`。

下图展示了A、B、C计算机访问服务器数据包的过程。

客户端使用IP地址定位服务器，**使用目标端口，定位服务**。

![5_5.png](images/5_5.png)

TCP和UDP相当于网络中的两扇大门，门上开的洞就相当于开发TCP和UDP的端口。如果想让服务器更加安全，就把能够通往应用层的TCP和UDP的两扇大门关闭，在大门上只开放必要的端口。

![5_6.png](images/5_6.png)

上面讲的是设置服务器的防火墙只开放必要的端口，以加强服务器的网络安全。也可以在路由器上设置访问控制列表`ACL`来实现网络防火墙的功能，控制内网访问Internet的流量。

![5_7.png](images/5_7.png)

## 二、UDP

### 1、UDP协议的特点

**无连接的用户数据报协议**。

用户数据报协议 (UDP) 只在IP地址的数据报服务之上增加了很少一点功能，就是**复用和分用的功能以及差错检测**的功能，复用和分用，就是使用端口标识不同的应用层协议。

* 传送数据之前不需要建立连接，收到UDP报文后也不需要给出任何确认；
* 使用尽最大努力交付，即不保证可靠交付，因此主机不需要维持复杂的连接状态表(这里面有许多参数)，通信的两端不用保持连接，因此节省系统资源；

 一个数据包就能完成数据通信、不分段、不需要建立会话、不需要流量控制、不可靠传输。

简言之: 不可靠、无连接、时延小、适用于小文件。

接收方 UDP 对 IP 层交上来的 UDP 用户数据报，在去除首部后就原封不动地交付上层的应用进程，**一次交付一个完整的报文**。

### 2、UDP首部格式

用抓包工具捕获的域名解析的数据包，域名解析使用DNS协议，在传输层使用UDP协议。如下图:

![5_8.png](images/5_8.png)

UDP 用户数据报有两个字段: 数据字段和首部字段。如图所示，首部字段很简单，只有8 个字节，由 4 个字段组成，每个字段的长度都是两个字节，各字段含义如下:

* 1)、 源端口。源端口号。在需要对方回信时选用。不需要时可用全 0。
* 2)、**目的端口。目的端口号。在终点交付报文时必须要使用到**。
* 3)、长度。UDP 用户数据报的长度，其最小值是8(仅有首部)。
* 4)、检验和。检测 UDP 用户数据报在传输中是否有错。有错就入弃。

![5_9.png](images/5_9.png)

UDP 用户数据报首部中检验和的计算方法有些特殊。在计算检验和时，要在 UDP 用户数据报之前增加 12 个字节的**伪首部**。所谓“伪首部” 是因为这种伪首部并不是 UDP 用户数据报真正的首部。

UDP校验:

在发送端:

* 1)、填上伪首部；
* 2)、全0填充检验和字段；
* 3)、全0填充数据部分(UDP数据报要看成许多4B的字串接起来)；
* 4)、伪首部+首部+数据部分采用二进制及码求和；
* 5)、把和求反码填入检验和字段；
* 6)、去掉伪首部，发送；

在接收端:
* 1)、填上伪首部；
* 2)、伪首部+首部+数据部分采用二进制反码求和；
* 3)、结果全为1则无差错，否则丢弃数据报/交给应用层附上出差错的警告(ICMP)；

![5_10.png](images/5_10.png)

## 三、TCP

**面向连接的传输控制协议**。

传送数据之前必须建立连接，数据传送结束后要释放连接。适用于大文件。

**不提供广播或多播服务**。

由于TCP要提供可靠的面向连接的传输服务，因此不可避免增加了许多开销:确认、流量控制、计时器及连接
管理等。

### 1、TCP协议的特点

* 1)、TCP是面向连接 (**虚连接**) 的传输层协议；(类似打call)
* 2)、每一条TCP连接只能有两个端点，每一条TCP连接**只能是点对点的**；
* 3)、TCP提供可靠交付的服务，无差错、不丢失、不重复、按序到达；(可靠有序，不丢不重)
* 4)、TCP提供**全双工通信**。
  * "**发送缓存**" : 准备发送的数据 & 已发送但尚未收到确认的数据；
  * "**接收缓存**" : 按序到达但尚未被接受应用程序读取的数据 &不按序到达的数据；
* 5)、TCP面向字节流。TCP把应用程序交下来的数据看成仅仅是一连串的无结构的字节流。流: 流入到进程或从进程流出的字节序列。
* 6)、TCP 不保证接收方应用程序所收到的数据块和发送方应用程序所发出的数据块具有对应大小的关系；但接收方应用程序收到的字节流必须和发送方应用程序发出的字节流完全一样；
* 7)、TCP 对应用进程一次把多长的报文发送到TCP 的缓存中是不关心的。 **TCP 根据对方给出的窗口值和当前网络拥塞的程度来决定一个报文段应包含多少个字节**（UDP 发送的报文长度是应用进程给出的）。

### 2、TCP连接

TCP 连接的端点不是主机，不是主机的IP 地址，不是应用进程，也不是运输层的协议端口。TCP 连接的端点叫做**套接字 (socket) 或插口**。
 **端口号拼接到 (contatenated with) IP 地址即构成了套接字**。

套接字 `socket = (IP地址: 端口号)`。

**每一条 TCP 连接唯一地被通信两端的两个端点（即两个套接字）所确定**。

TCP 连接` ::= {socket1, socket2} = { (IP1: port1)，(IP2: port2) } `

同一个 IP 地址可以有多个不同的 TCP 连接。

同一个端口号也可以出现在多个不同的 TCP 连接中。

### 2、TCP首部格式

首部格式:

<div align="center"> <img src="images/5_11.png" width="670"></div><br>

相关字段解释(对于理解TCP很重要)

* 序号: 在一个TCP连接中传送的字节流中的每一个字节都按顺序编号，本字段表示本报文段所发送数据的第一个字节的序号，例如发送报文段`1-2-3`，则序号是`1`。
* 确认号: **期望收到对方下一个报文段的第一个数据字节的序号**。若确认号为N,则证明到序号N-1为止的所有数据都已正确收到。例如 B 正确收到 A 发送来的一个报文段，序号为 301，携带的数据长度为 100 字节，因此 B 期望下一个报文段的序号为 401，B 发送给 A 的确认报文段中确认号就为 401；
* 数据偏移(**首部长度**) : TCP报文段的数据起始处距离TCP报文段的起始处有多远，以4B位单位，即1个数值是4B。
* 6个控制位。
  * **紧急位URG** : URG=1时，标明此报文段中有紧急数据，是高优先级的数据，应尽快传送，不用在缓存里排队，配合**紧急指针字段**使用；
  * **确认位ACK** : ACK=1时确认号有效，在连接建立后所有传送的报文段都必须把ACK置为1；
  * **推送位PSH** : PSH=1时，**接收方尽快交付接收应用进程，不再等到缓存填满再向上交付**；
  * **复位RST** : RST=1时，表明TCP连接中出现严重差错，必须释放连接，然后再**重新建立**传输链接；
  * **同步位SYN** : SYN=1时，表明是一个连接请求/连接接受报文；
  * **终止位FIN** : FIN=1时，表明此报文段发送方数据已发完，**要求释放连接**。
* **窗口** ：窗口值作为接收方让发送方设置其发送窗口的依据。之所以要有这个限制，是因为接收方的数据缓存空间是有限的。
* 检验和: 占 2 字节。检验和字段检验的范围包括首部和数据这两部分。在计算检验和时，要在 TCP 报文段的前面加上 12 字节的伪首部。 
* 紧急指针: URG = 1时才有意义，指出本报文段紧急数据的字节数；
* 选项: 最大报文段长度MSS、窗口扩大、时间戳、时间确认....；

> MSS (Maximum Segment Size)是 TCP 报文段中的数据字段的最大长度。**数据字段加上 TCP 首部才等于整个的 TCP 报文段**。所以，MSS是 `TCP 报文段长度 -  TCP 首部长度`；

捕获的TCP报文段:

![5_12.png](images/5_12.png)

## 三、TCP连接管理

### 1、TCP的连接建立

TCP连接传输三个阶段:

* 连接建立；
* 数据传送；
* 连接释放；

TCP连接的建立采用客户端服务器方式，主动发起连接建立的应用进程叫做客户，而被动等待连接建立的应用进程叫服务器。

### 2、TCP的连接释放









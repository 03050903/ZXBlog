# 计网总结(四)一网络层


* [一、数据交换方式](#一数据交换方式)
* [二、IP数据报](#二ip数据报)
* [三、IP地址](#三ip地址)
* IP地址和子网划分
* 静态路由和动态路由
* 网络层相关协议

## 一、数据交换方式

第一章提到数据交换方式分为电路交换、报文交换、分组交换。

其中在网络层。分组交换又可以分为**数据报方式和虚电路方式**。

其中，**数据报方式为网络层提供无连接服务**。**虚电路方式为网路层提供连接服务**。

> 无连接服务: 不事先为分组的传输确定传输路径，每个分组独立确定传输路径，不同分组传输路径可能不同。
>
> 连接服务: 首先为分组的**传输确定传输路径**(建立连接) ，然后沿该路径传输系列分组，系列分组传输路径相同，传输结束后拆除连接。

几种传输单元在各层的位置:

![4_1.png](images/4_1.png)

下面看数据包方式和虚电路交换方式:

![4_2.png](images/4_2.png)

对比:

![4_3.png](images/4_3.png)

## 二、IP数据报

### 1、IP数据报格式

![4_6.png](images/4_6.png)

一个 IP 数据报由首部和数据两部分组成。首部的前一部分是固定长度，共` 20 `字节，是所有 IP 数据报必须具有的。在首部的固定部分的后面是一些可选字段，其长度是可变的。 

* 版本——占 4 位，指 IP 协议的版本。目前的 IP 协议版本号为 4 (即 IPv4)；

* 首部长度——占 4 位，可表示的最大数值是 15 个单位(一个单位为 4 字节)，因此 IP 的首部长度的最大值是 60 字节；

* 总长度——占 16 位，指首部和数据之和的长度，单位为字节，因此数据报的最大长度为 65535 字节。总长度必须不超过最大传送单元 MTU(数据链路层规定)；

* 标识(identification) ——占 16 位，它是一个计数器，用来产生 IP 数据报的标识。；

* 标志(flag) ——占 3 位，目前只有前两位有意义。标志字段的最低位是 MF (More Fragment)。MF = 1 表示后面“还有分片”。MF = 0 表示最后一个分片。标志字段中间的一位是 DF (Don't Fragment) 。只有当 DF = 0 时才允许分片； 

* 片偏移——占13 位，指出：较长的分组在分片后某片在原分组中的相对位置。片偏移以 8 个字节为偏移单位；

* 生存时间——占8 位，记为 TTL (Time To Live)，指示数据报在网络中可通过的路由器数的最大值；

* 协议——占8 位，指出此数据报携带的数据使用何种协议，以便目的主机的 IP 层将数据部分上交给那个处理过程；

* 首部检验和——占16 位，只检验数据报的首部，不检验数据部分。这里不采用 CRC 检验码而采用简单的计算方法。 

![在这里插入图片描述](images/4_14.png)
### 2、IP数据报分片

当IP数据报传送到链路层的时候，如果IP数据报长度超过MTU，就需要分片。

![4_16.png](images/4_16.png)

具体的分片过程:

![4_7.png](images/4_7.png)

> 中间位 DF(Don't Fragment)
>
> * DF = 1 ，禁止分片；
> * DF = 0，允许分片；
>
> 最低位MF(More Fragment)
>
> * MF = 1，后面"还有分片"；
> * MF = 0，代表最后一片/没分片；

## 三、IP地址

### 1、IP地址概念

* `IP` 地址就是给每个连接在互联网上的主机（或路由器）分配一个在全世界范围是唯一的 `32` 位的标识符，用来定位网络中的计算机和网络设备；
* IP 地址用 `32` 位二进制来表示， 也就是`32` 比特， 换算成字节， 就 是 `4` 个字节。例如一个采用二进制形式的 IP 地址是`10101100 00010000 00011110 00111000 `， 这么长的地址， 处理起来太费劲。于是这些位被分割为`4`    个部分， 每一部分` 8 `位二进制， 中间使用符号 `.`分开 ，上面的 `IP` 地址可以表示为`172.16.30.56`。`IP` 地址的这种表示法叫做“点分十进制表示法”；
* 计算机的 `IP` 地址由两部分组成， **一部分为网络标识， 一部分为主机标识**；同 一网段的计算机网络部分相同。路由器连接不同网段，负责不同网段之间的数据转发，交换机连接的则是同一网段的计算机；见下图: 
![在这里插入图片描述](images/4_9.png)

> 计算机在和其他计算机通信之前， 首先要判断目标 `IP`  地址和自己的`IP`  地址是否在一个网段， 这决定了数据链路层的目标 `MAC` 地址是目标计算机的还是路由器接口的。 

### 2、子网掩码

* 子网掩码 ( `Subnet Mask`) 又叫网络掩码、地址掩码，它是一种用来指明一个`IP`地址的哪些位标识的是主机所在的子网以及哪些位标识的是主机的位掩码。**子网掩码只有一个作用，就是将某个`IP`  地址划分成网络地址和主机地址两部分**。
* 例如: 计算机的 `IP` 地址是 `131.107.41.6`,  子网掩码是 `255.255.0.0`,  计算机所在网段是`131.107.0.0`。该计算机和远程计算机通信 ，目标 `IP` 地址只要前面两部分是 `131.107`就认为和 该计算机在同一个网段；

通过`IP`和子网掩码计算网段: 

方法:  IP 地址和子网掩码做**与运算**：

![在这里插入图片描述](images/4_10.png)

有关二进制的特殊转换和特征(和划分子网有关系): 
|二进制|十进制|备注|
|-|-|-|
|1000 0000	|128||
|1100 0000|192| 1000 0000+ 10 0000 也就是 128 + 64=192|
|1110 0000|224| 1000 0000 + 100 0000 + 10 0000 也就是 128  + 64 + 32=224|
|1111 0000|240| 128 + 64 + 32 + 16 = 240|
|1111 1000|248| 128 + 64 + 32 + 16 + 8 = 248|
|1111 1100|252| 128 + 64 + 32 + 16 + 8 + 4 = 252|
|1111 1110|254| 128 + 64 + 32+ 16 + 8 + 4 + 2=254|
|1111 1111|255| 128 + 64 + 32 + 16 + 8 + 4 + 2 + 1=255|

![在这里插入图片描述](images/4_11.png)

一个规律，**如果要你写出十进制转换成二进制后，后n位二进制是多少**: 

> * 能够被 `2` 整除的数， 写成二进制形式， 后一位是 `0`。如果余数是` 1 `,  则最后一位是 `1`。 
> * 能够被 `4 `整除的数， 写成二进制形式， 后两位是 `00`。如果余数是`2` , 那就把 `2 `写成二进制，后两位是`10 `。
> * 能够被 `8` 整除的数， 写成二进制形式， 最后三位是 `000 `。如果余 `5` , 就把`5 `写成二进制， 后三位是 `101`。
> * 能够被 `16` 整除的数， 写成二进制形式， 最后四位是 `0000` 。如果余 `6` ,   就把`6 `写成二进制， 最后四位是 `0110` 。


我们可以找出规律， 如果让你写出一个十进制数转换成二进制数后面的 `n` 位二进制数 ，你可以将该数除以 2<sup>n</sup>,    将余数写成 `n` 位二进制即可。

举例:  写出十进制数 242 转换成二进制数后的最后 4 位: 
2<sup>4</sup>   是 `16` ,  `242` 除以 `16 `,  余 `2` ,  将余数写成 4 位二进制，就是 `0010` 。

### 3、IP地址分类

如图所示: 

* A类地址: **网络地址最高位是 `0` 的地址为 A 类地址**。网络 ID 全 `0` 不能用，`127` 作为保留网段，因此 A 类地址的第 1 部分取值范围为 `1~126`；A 类网络默认子网掩码为`255.0.0.0`。主机ID 由第 2 部分、第 3 部分和第 4 部分组成，每部分的取值范围为 `0~255`，共 256 种取值，由排列组合知道，一个 A 类网络主机数量是 `256 * 256 * 256=166777216`，这里还需减去` 2`，主机 ID 全 0 的地址为网络地址，而主机ID 全 `1` 的地址为广播地址，如果你给主机 ID 全 `1` 的地址发送数据包，计算机产生一个数据链路层广播帧，**发送到本网段全部计算机**；
* B类地址: **网络地址最高位是`10`的地址为B类地址**。IP地址第一部分取值范围为`128 ~ 191`。B类网络默认子网掩码为 `255.255.0.0`。主机 ID 由第 3 部分和第 4 部分组成，每个 B 类网络可以容纳的最大主机数量为 `256X256-2=65023` ；
* C类地址: **网络地址最高位是`110`的地址为C类地址**。IP地址第一部分取值范围为`192 ~ 223`。子网掩码是`255.255.255.0`，主机ID由第4部分组成，每个C类网络可以容纳的最大主机数量为`256 - 2 = 254`；

![在这里插入图片描述](images/4_12.png)

 数轴表示:![在这里插入图片描述](images/4_13.png)



* 一个`A`类网络的主机数量是`256`*`256`*`256`个，这里还需要减去`2`，因为主机`ID`全`0`的地址为网络地址，而主机`ID`全`1`的地址为广播地址，如果给主机`ID`全1的`IP`地址发送数据包，这个电脑将产生一个数据链路层广播帧，发送到本网段全部计算机；
* 在电脑中，我们只需要写出自己的`IP`地址，按下`TAB`键，就能自动将子网掩码补全，这就说明，可以按照前`8`位来推断是哪一类地址，然后推断子网掩码。子网掩码可以来划分网络部分(`net-id`)和主机部分(`host-id`)；
* 在同一个局域网上的主机或路由器的IP 地址中的网络号(`net-id`)必须是一样的。
* 路由器总是具有两个或两个以上的 IP 地址。路由器的每一个接口(`fastethernet`或者`serial`)都有一个不同网络号的 IP 地址。


**保留的IP地址**
有些 IP 地址被保留用于某些特殊目的， 网络管理员不能将这些地址分配给计算机。
* 主机 `ID` 全为 0 的地址： 特指某个网段， 比如 `192.168. 10.0 255.255.255.0`,  指 `192.168.10.0`网段(**网段也叫网络地址**)；
* 主机`ID` 全为 1 的地址： 特指该网段的全部主机 ，如果你的计算机发送数据包使用主机 ID 全是 1 的 IP  地址， 数据链路层地址用广播地址 `FF-FF-FF-FF-FF-FF`。同一网段计算机名称解析就需要发送名称解析的广播包。比如你的计算机 lP 地址是` 192.168.10.10` ,  子网掩码是 `255.255.255.0 `, 它要发送一个广播包， 如目标 IP 地址是 `192.168.10.255` , 帧的目标MAC  地址是 `FF-FF-FF-FF-FF-FF`，该网段中全部计算机都能收到；
* `127.0.0.1`：  是回送地址， 指本机地址， 一般用作测试使用。回送地址 ( `127 .x.x.x` )  即本机回送地址 ( `Loopback Address` ) , 指主机 IP 堆栈内部的 IP 地址， 主要用于网络软件测试以及本地机进程间通信， 无论什么程序， 一旦使用回送地址发送数据， 协议软件立即返回， 不进行任何网络传输。任何计算机都可以用该地址访问自己的共享资源或网站，如果  ping该地址能够通， 说明你的计算机的 `TCP/IP `协议栈工作正常， 即便你的计算机没有网卡，ping `127.0.0.1` 还是能够通的；
* `169. 254.0.0`： `169.254.0.0 ~ 169.254.255.255` 实际上是自动私有 IP 地址。 如果计算机无法获取 IP 地址， 对于Windows  2000 以后的操作系统， 则在无法获取 IP  地址时自动配置成 `" IP地址： 169.254.x.x "，" 子网掩码：255.255.0.0“`，这样可以使所有获取不到IP地址的计算机能够通信；


**私网地址和公网地址**

私网 IP 地址可以被用于私有网络 ，在 lnternet 上没有这些 IP 地址， Internet 上的路由器也没有到私有网络的路由表。**我们在 Internet 上不能访问这些私网地址， 从这一点来说使用私网地址的计算机更加安全 ，也有效地节省了宝贵的公网IP 地址**。使用私网地址的计算机可以通过 **NAT** ( Network Address Translation , 网络地址转换）技术访问Internet。

下面列出保留的私有IP 地址。

* A 类： `10.0.0.0 [255.0.0.0]`，  保留了一个 A 类网络。
* B 类： `112.16.0.0 [255.255.0.0] ~ 112.31.0.0 [255.255.0.0]`,    保留了16个B类网络。
* C 类： `192.168.0.0 [255.255.255.0]  ~ 192.168.255.0 [255.255.255.0]`，   保留了 256 个C类网络。

关于**网络地址转换NAT**

由于**路由器对目的地址是私有IP地址的数据包一律不转发**。所以需要使用`NAT`来使得私有地址访问`Internet`。

在专用网链接到因特网的路由器上安装了NAT软件，安装了NAT软件的路由器叫NAT路由器。

![4_18.png](images/4_18.png)

### 4、子网划分

子网划分就是**将一个网段等分成多个网段，也就是等分成多个子网**。

任务:

* 确定子网掩码的长度；
* 确定子网中第一个可用的IP地址和最后一个可用的IP地址；

#### 1)、等分成两个子网

下面以一个 C 类网络划分为两个子网为例，讲解子网划分的过程。

如图 所示，某公司有两个部门，每个部门 100 台计算机，通过路由器连接 Internet。给这200台电脑分配一个 C 类网络 `192.168.0.0`，该网段的子网掩码为 `255.255.255.0`，连接局域网的路由器接口使用该网段的第一个可用的IP地址 `192.168.0.1`。

![4_19.png](images/4_19.png)

为了安全考虑，打算将这两个部门的计算机分为两个网段，中间使用路由器隔开。计算机数量没有增加，还是 200 台，因此一个 C 类网络的IP地址是足够用的。现在将 `192.168.0.0 [255.255.255.0]`这个 C 类网络划分成两个子网。

如图所示，将IP地址的第 4 部分写成二进制形式，子网掩码使用两种方式表示: 二进制和十进制。**子网掩码往右移一位，这样C类地址主机ID 第1位就成为网络位, 该位为 0 是 A子网，该位为1是B子网**。

![4_20.png](images/4_20.png)

如图所示，IP 地址的第 4 部分，其值在 `0~127` 之间的，第 1 位均为 0；其值在 `128~255`之间的，第 1 位均为 1。分成A、B 两个子网，以 128 为界。现在的子网掩码中的1变成了 25 个，写成十进制就是 255.255.255.128。子网掩码向后移动了 1 位，就划分出 2 个子网。**A和B 两个子网的子网掩码都为235.255.255.128** 。

A子网可用的地址范围为 `192.168.0.1~192.168.0.126`，IP 地址 192.168.0.0 由于主机位全为 0，不能分配给计算机使用，如图 所示，`192.168.0.127` 由于主机位全为 1，也不能分配计算机。

![4_21.png](images/4_21.png)

B 子网可用的地址范围为`192.168.0.129~192.168.0.254`，IP 地址 `192.168.0.128` 由于主机位全为0，不能分配给计算机使用，IP 地址 `192.168.0.255` 由于主机位全为 1，也不能分配给计算机。划分成两个子网后网络规划如图所示。

![4_22.png](images/4_22.png)


## 网络层相关协议
![在这里插入图片描述](images/4_15.png)



 

![4_17.png](images/4_17.png)




数据包传输过程以及简单的静态路由配置

![在这里插入图片描述](images/4_5.png)





发送过程: 
* 应用程序准备要传输的文件；
* 传输层: 将文件分段 并编号；
* 网络层: 添加目标`IP`地址和源`IP`地址，路由器根据路由表来选择路径(出口)；
* 数据链路层 两种情况： 先使用自己的子网掩码，判断自己在哪个网段，然后判断目标地址在哪个网段， 如果是同一个网段 `arp`协议广播解析目标IP地址的`MAC` ；这一层的交换机接收到数字信号，看`MAC`地址，决定发送到下一个哪个交换机，即数据转发或存储转发。 (交换机看不到`ip`地址，只能看`MAC`地址)；
* 物理层负责转换成比特流，进行数字信号的传输(注意这一层的集线器只是负责传输比特流)；

> 数据包的目标 `IP` 地址决定了数据包最终到达哪一个计算机， 而目标 `MAC`地址决定了该数据包下一跳由哪个设备接收，


附上路由器`Router0`和`Router1`的配置代码
`Router0`配置: 

```c
Router>en
Router#conf ter
Router(config)#int f0/0
Router(config-if)#no shut
Router(config-if)#ip address 10.0.0.1 255.0.0.0
Router(config-if)#exit
Router(config)#interface serial 2/0
Router(config-if)#no shutdown
Router(config-if)#clock rate 64000
Router(config-if)#ip address 11.0.0.1 255.0.0.0
Router(config-if)#end
Router#show ip route
Router#conf ter
Router(config)#ip route 12.0.0.0 255.0.0.0 11.0.0.2
Router#show ip route
```
`Router1`路由器配置: 

```c
Router>en
Router#conf ter
Router(config)#interface fastethernet 0/0
Router(config-if)#ip address 12.0.0.1 255.0.0.0
Router(config-if)#no shut
Router(config-if)#exit
Router(config)#interface serial 2/0
Router(config-if)#ip address 11.0.0.2 255.0.0.0
Router(config-if)#no shutdown
Router(config)#exit
Router#show ip route
Router#conf ter
Router(config)#ip route 10.0.0.0 255.0.0.0 11.0.0.1
Router(config)#end
Router#show ip route
Router#show running-config
```

网络层的四个主要的协议: `ARP`、`IP`、`ICMP`、`IGMP`。

![在这里插入图片描述](images/4_4.png)



**将网络互相连接起来要使用一些中间设备。 中间设备又称为中间系统或中继 (`relay`)系统。有以下五种不同的中间设备：**
* 物理层中继系统：转发器 (`repeater`)、集线器（`hub`）。
* 数据链路层中继系统：网桥、桥接器 (`bridge`)、交换机(`switch`)。
* 网络层中继系统：路由器 (`router`)。
* 网桥和路由器的混合物：桥路器 (`brouter`)。
* 网络层以上的中继系统：网关 (`gateway`)。  

**IP地址和硬件地址的区别** 

![在这里插入图片描述](images/4_8.png)
